name: Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository
      - name: Check out the repository
        uses: actions/checkout@v2

      # Decode PEM files from Base64 secrets and create .pem files
      - name: Create PEM files from secrets
        env:
          CLIENT_KEY: ${{ secrets.CLIENT_KEY }}
          CLIENT_CERT: ${{ secrets.CLIENT_CERT }}
          SERVER_CA: ${{ secrets.SERVER_CA }}
        run: |
          echo "$CLIENT_KEY" | base64 -d > client-key.pem
          echo "$CLIENT_CERT" | base64 -d > client-cert.pem
          echo "$SERVER_CA" | base64 -d > server-ca-2.pem

      # Connect to MySQL using the decoded PEM files
      - name: Connect to MySQL
        env:
          MYSQL_HOST: 104.154.129.2
          MYSQL_USER: root
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
        run: |
          mysql -u"$MYSQL_USER" -p"$MYSQL_PASSWORD" -h "$MYSQL_HOST" \
            --ssl-ca=server-ca-2.pem --ssl-cert=client-cert.pem --ssl-key=client-key.pem \
            -e "SHOW DATABASES;"

      # Clean up PEM files after use
      - name: Clean up PEM files
        run: |
          rm client-key.pem client-cert.pem server-ca.pem
